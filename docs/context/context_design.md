## ä»‹ç»
è¿™æ˜¯Memciçš„ä¸Šä¸‹æ–‡ç®¡ç†è®¾è®¡æ–‡æ¡£ã€‚

## è¯¦ç»†è®¾è®¡æ–‡æ¡£

æœ¬æ–‡æ¡£æä¾›æ•´ä½“æ¶æ„è§†å›¾ï¼Œå…·ä½“çš„ç»„ä»¶è®¾è®¡è¯·å‚è€ƒä»¥ä¸‹ç‹¬ç«‹æ–‡æ¡£ï¼š

| ç»„ä»¶ | è®¾è®¡æ–‡æ¡£ | è¯´æ˜ |
|------|----------|------|
| **Page** | [page.md](page.md) | Pageæ¥å£ã€DetailPageã€ContentsPageçš„è®¾è®¡ä¸å®ç° |
| **Segment** | [segment.md](segment.md) | Segmentåˆ†æ®µç®¡ç†ã€æƒé™æ§åˆ¶è®¾è®¡ |
| **ContextSystem** | [context_system.md](context_system.md) | æ ¸å¿ƒç³»ç»Ÿå†…éƒ¨æ–¹æ³•è®¾è®¡ |
| **AgentContext** | [agent_context.md](agent_context.md) | Agentä»£ç†å±‚ã€æƒé™æ£€æŸ¥ |
| **ContextWindow** | [context_window.md](context_window.md) | Page Tree æ¸²æŸ“ä¸º MessageList |
| **ContextManager** | [context_manager.md](context_manager.md) | ç»Ÿä¸€ç®¡ç†å±‚ï¼Œåè°ƒæ‰€æœ‰ç»„ä»¶ |

## åŸºæœ¬æƒ³æ³•
ç±»æ¯”æ–‡ä»¶ç³»ç»Ÿä¸­ç›®å½•å’Œæ–‡ä»¶çš„æ¦‚å¿µï¼Œåœ¨Agentä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿä¸­æŠ½è±¡å‡ºä¸€å¥—æ ‘å½¢çš„ä¸Šä¸‹æ–‡æŠ½è±¡å±‚æ¬¡ã€‚PageæŠ½è±¡ç±»æ¯”å¹¿ä¹‰æ–‡ä»¶ï¼ŒåŒ…å«æ–‡ä»¶å’Œç›®å½•ï¼›DetailPageå®ç°Pageæ¥å£ï¼Œç±»æ¯”ç‹­ä¹‰æ–‡ä»¶ï¼Œç”¨äºå­˜å‚¨åŸå§‹çš„messagelistï¼›ContentsPageç±»æ¯”ç›®å½•ï¼ŒåŒæ ·å®ç°Pageæ¥å£ï¼Œå­˜å‚¨å¯¹ä¸‹çº§DetailPageæˆ–ContentsPageçš„æ‘˜è¦ã€‚æ•´ä¸ªç³»ç»Ÿæ•´ä½“å½¢æˆä¸€ä¸ªå¶å­èŠ‚ç‚¹æ˜¯DetailPageï¼ŒContentsPageå±‚å±‚é€’å½’çš„æ ‘å½¢ç»“æ„

## åŸºæœ¬æŠ½è±¡
- **MessageNode**: messageåŒ…ä¸‹çš„æŠ½è±¡ï¼Œæ¶ˆæ¯é“¾è¡¨çš„èŠ‚ç‚¹ï¼ŒåŒ…å«æ¶ˆæ¯å†…å®¹å’Œå‰åèŠ‚ç‚¹æŒ‡é’ˆ
- **MessageList**: messageåŒ…ä¸‹çš„æŠ½è±¡ï¼Œæ¶ˆæ¯é“¾è¡¨ï¼Œå†…éƒ¨èŠ‚ç‚¹ç±»å‹æ˜¯messagenodeï¼ŒåŒå‘é“¾è¡¨
- **Page**: Pageæ˜¯æ¥å£æŠ½è±¡ï¼ŒContentsPageçš„å­èŠ‚ç‚¹æœ‰å¯èƒ½æ˜¯ContentsPageæˆ–DetailPageï¼Œæ‰€ä»¥å¿…é¡»æä¾›Pageè¿™ä¸ªæŠ½è±¡ï¼ŒContentsPageçš„å­èŠ‚ç‚¹ç±»å‹ä½¿ç”¨Pageæ¥å£ç±»å‹ã€‚Pageå…·æœ‰ç”Ÿå‘½å‘¨æœŸæ¦‚å¿µã€‚
- **DetailPage**: ä¸€ä¸ª DetailPage é€»è¾‘ä¸Šå¯¹åº”ä¸ç”¨æˆ·çš„ä¸€æ¬¡äº¤äº’äº§ç”Ÿçš„messageï¼ˆä¸€æ¡ç”¨æˆ· message ä»¥åŠå¤šæ¡ message æˆ– tool messageã€‚DetailPageæŒæœ‰detailå­—æ®µï¼Œè¯¥å­—æ®µæ˜¯å°†ä¸€æ¬¡äº¤äº’çš„æ‰€æœ‰messageè¿›è¡Œåˆå¹¶è€Œæ¥ã€‚DetailPageæŒæœ‰ä¸€ä¸ªdescriptionå­—æ®µï¼Œç”¨ä»¥æè¿°è¯¥é¡µä¸»è¦å†…å®¹
- **ContentsPage**: ContentsPageå®ç°Pageæ¥å£ï¼ŒContentsPageä¸æ‹¥æœ‰messagelistã€‚ContentsPageæŒæœ‰ä¸€ä¸ªdescriptionå­—æ®µï¼Œç”¨ä»¥æè¿°ç›®å½•çš„ä¸»è¦å†…å®¹
- **Segment**: æä¾›ä¸€ç»„é€»è¾‘ä¸Šç›¸å…³çš„Pageé›†åˆçš„è§†å›¾ï¼ŒSegmentçš„ä¸»è¦ä½œç”¨æ˜¯ç»™æ•´ä¸ªä¸Šä¸‹æ–‡ç©ºé—´æä¾›é€»è¾‘ä¸Šçš„åˆ†æ®µï¼ŒSegmentå¯¹Agentæ˜¯ä¸å¯è§çš„ï¼Œä½†ä»–æ–¹ä¾¿å¼€å‘è€…åˆ†æ®µç®¡ç†ä¸Šä¸‹æ–‡ç©ºé—´ï¼Œä¾‹å¦‚åˆ†ä¸ºç³»ç»Ÿæç¤ºè¯æ®µå’Œç”¨æˆ·äº¤äº’æ®µ
- **ContextSystem**: ContextSystem å¯¹è±¡ç”¨äºæŠ½è±¡æ•´ä¸ªä¸Šä¸‹æ–‡ç³»ç»Ÿï¼Œè´Ÿè´£ç®¡ç† Page å’Œ Segment çš„å­˜å‚¨
- **ContextWindow**: ContextWindow è´Ÿè´£å°† Page Tree æ¸²æŸ“ä¸º MessageListï¼Œæ˜¯æœ€ç»ˆå‘é€ç»™æ¨¡å‹çš„å†…å®¹
- **AgentContext**: AgentContext æ˜¯ Agent ä¸ ContextSystem äº¤äº’çš„ä»£ç†å±‚ï¼Œè´Ÿè´£æƒé™æ£€æŸ¥
- **ContextManager**: ContextManager æ˜¯ç»Ÿä¸€ç®¡ç†å±‚ï¼Œåè°ƒ AgentContext å’Œ ContextWindowï¼Œæ˜¯åº”ç”¨å±‚çš„å•ä¸€å…¥å£
- **Storage**: PageæŒä¹…åŒ–æ¥å£ï¼Œæä¾›å¯æ’æ‹”çš„å­˜å‚¨å®ç°ï¼ˆå†…å­˜ã€æ–‡ä»¶ã€æ•°æ®åº“ç­‰ï¼‰ï¼Œæ”¯æŒè‡ªåŠ¨æŒä¹…åŒ–å’Œæ‡’åŠ è½½

### æ•´ä½“æ ‘å½¢ç»“æ„

```
åº”ç”¨å±‚
    â”‚
    â–¼
ContextManager (ç»Ÿä¸€ç®¡ç†å±‚) - å•ä¾‹å…¥å£
    â”‚
    â”œâ”€â”€ ContextSystem (å­˜å‚¨å±‚)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ Segment ç®¡ç†
    â”‚   â”‚   â”œâ”€â”€ Segment (ç³»ç»Ÿæç¤ºè¯æ®µ)
    â”‚   â”‚   â”‚   â””â”€â”€ rootIndex â†’ sys-0
    â”‚   â”‚   â””â”€â”€ Segment (ç”¨æˆ·äº¤äº’æ®µ)
    â”‚   â”‚       â””â”€â”€ rootIndex â†’ usr-0
    â”‚   â”‚
    â”‚   â”œâ”€â”€ Page å­˜å‚¨ (å…¨å±€ Page æ³¨å†Œè¡¨)
    â”‚   â”‚   â””â”€â”€ Page Tree ç»“æ„:
    â”‚   â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   â”‚       â”‚ ContentsPage (sys-0) [Expanded] â”‚ â† Segment Root
    â”‚   â”‚       â”‚   â”œâ”€ DetailPage (sys-1)         â”‚
    â”‚   â”‚       â”‚   â””â”€ DetailPage (sys-2)         â”‚
    â”‚   â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚   â”‚       â”‚ ContentsPage (usr-0) [Expanded] â”‚ â† Segment Root
    â”‚   â”‚       â”‚   â”œâ”€ ContentsPage (usr-1)       â”‚
    â”‚   â”‚       â”‚   â”‚   â”œâ”€ DetailPage (usr-1-1)   â”‚
    â”‚   â”‚       â”‚   â”‚   â””â”€ DetailPage (usr-1-2)   â”‚
    â”‚   â”‚       â”‚   â””â”€ DetailPage (usr-2)         â”‚
    â”‚   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚   â”‚
    â”‚   â””â”€â”€ Storage (æŒä¹…åŒ–å±‚)
    â”‚       â”œâ”€â”€ æ¥å£æ¨¡å¼: å¯æ’æ‹”å­˜å‚¨å®ç°
    â”‚       â”œâ”€â”€ æ”¯æŒç±»å‹: MemoryStorage, FileStorage, DatabaseStorage
    â”‚       â”œâ”€â”€ è‡ªåŠ¨æŒä¹…åŒ–: å†™æ“ä½œè‡ªåŠ¨åŒæ­¥åˆ°å­˜å‚¨
    â”‚       â””â”€â”€ æ‡’åŠ è½½: è¯»æ“ä½œæŒ‰éœ€ä»å­˜å‚¨åŠ è½½
    â”‚
    â”œâ”€â”€ AgentContext (ä»£ç†å±‚) - å†™æ“ä½œ
    â”‚   â”‚
    â”‚   â”œâ”€â”€ æƒé™æ£€æŸ¥
    â”‚   â”œâ”€â”€ ä»£ç†è°ƒç”¨å†…éƒ¨æ–¹æ³•
    â”‚   â””â”€â”€ è¾“å‡º: Agent æ“ä½œç»“æœ
    â”‚
    â””â”€â”€ ContextWindow (æ¸²æŸ“å±‚) - è¯»æ“ä½œ
        â”‚
        â”œâ”€â”€ éå† Active Page Tree
        â”œâ”€â”€ æ ¹æ® Visibility æ¸²æŸ“
        â””â”€â”€ è¾“å‡º: MessageList (å‘é€ç»™æ¨¡å‹)
```

**ä½¿ç”¨æµç¨‹**ï¼š
```go
// åº”ç”¨åªéœ€åˆ›å»ºä¸€ä¸ª ContextManager
contextMgr := context.NewContextManager()
contextMgr.Initialize()

// æ‰€æœ‰æ“ä½œé€šè¿‡ ContextManager
contextMgr.CreateDetailPage(...)
contextMgr.ExpandDetails(...)

// ç”Ÿæˆæ¶ˆæ¯
messageList := contextMgr.GenerateMessageList()
```

## ä¸Šä¸‹æ–‡ç³»ç»Ÿæ ¸å¿ƒæ“ä½œ
### ç³»ç»Ÿè‡ªåŠ¨å®Œæˆ
#### åˆ›å»ºDetailPage
- createDetailPage(name, description, detail, parentPageIndex)
- æ–°åˆ›å»ºçš„detailPageé»˜è®¤åªå±•ç¤ºdescription


### ä¸ºAgentæä¾›çš„æ“ä½œæ¥å£

**é‡è¦è¯´æ˜**ï¼šæ‰€æœ‰æ“ä½œéƒ½ä¾èµ– `pageIndex` æ¥æ ‡è¯†Pageã€‚Agenté€šè¿‡è§†å›¾ä¸­çš„ `[index: X]` ä¿¡æ¯è·å–ç´¢å¼•ï¼Œæ‰€æœ‰ç´¢å¼•åœ¨å½“å‰ä¼šè¯ä¸­å”¯ä¸€ä¸”ç¨³å®šã€‚

#### åˆ›å»ºç›®å½•é¡µ
- createContentsPage(name, description, parentPageIndex, pageIndex1, pageIndex2, ...)

#### ç§»åŠ¨é¡µ
- movePage(sourcePageIndex, targetPageIndex)
- å¯ä»¥ç§»åŠ¨detailPageåˆ°ContentsPageç›®å½•ä¸‹ï¼Œä¹Ÿå¯ä»¥æ˜¯æŠŠContentsPageç§»åˆ°ContentsPageä¸‹

#### é‡å‘½åæˆ–æ›´æ–°æè¿°
- updatePage(pageIndex, name, description)
- æ“ä½œå¯¹è±¡å¯ä»¥æ˜¯DetailPageæˆ–ContentsPage

#### å±•å¼€è¯¦æƒ…
- expandDetails(pageIndex)
- æ“ä½œå¯¹è±¡å¯ä»¥æ˜¯DetailPageæˆ–ContentsPage
- æŸ¥çœ‹é¡µè¯¦æƒ…ï¼Œå¦‚æœæ˜¯DetailPageï¼Œå°±æ˜¯å±•å¼€åŸå§‹å†…å®¹(messagelistä¸­çš„å†…å®¹)ï¼›å¦‚æœæ˜¯ContentsPageï¼Œå°±æ˜¯å±•å¼€å…¶å­pageçš„indexï¼Œnameå’Œdescription

#### éšè—è¯¦æƒ…
- hideDetails(pageIndex)
- æ“ä½œå¯¹è±¡å¯ä»¥æ˜¯DetailPageæˆ–ContentsPage
- éšè—é¡µè¯¦æƒ…ï¼Œå¦‚æœæ˜¯DetailPageï¼Œå°±æ˜¯éšè—åŸå§‹å†…å®¹ä½†descriptionä»ç„¶å¯è§ï¼›å¦‚æœæ˜¯ContentsPageï¼Œä¿ç•™å…¶descriptionï¼Œä½†å…¶å­©å­èŠ‚ç‚¹ä¸å¯è§

#### åˆ é™¤é¡µ
- removePage(pageIndex)
- æ“ä½œå¯¹è±¡å¯ä»¥æ˜¯DetailPageæˆ–ContentsPage
- å°†pageåŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹å¸è½½å‡ºä¸Šä¸‹æ–‡ç³»ç»Ÿï¼Œç”±å¤–éƒ¨æ•°æ®åº“ç»´æŠ¤

#### åˆ›å»ºDetailPage
- createDetailPage(name, description, detail, parentPageIndex)
- ç³»ç»Ÿä¼šä¸ºæ¯è½®äº¤äº’è‡ªåŠ¨åˆ›å»ºdetailPageï¼Œä½†ä¾ç„¶å¼€æ”¾è¿™ä¸ªæ¥å£ç»™Agentï¼ŒAgentå¯ä»¥è‡ªè¡Œåˆ›å»ºDetailPageæ¥è®°å½•ä¸€äº›ç»éªŒå’Œæ•™è®­
- **å¿…é¡»æŒ‡å®š parentPageIndex**ï¼ˆé™¤äº† root page å¤–ï¼Œæ‰€æœ‰ Page éƒ½å¿…é¡»æœ‰çˆ¶èŠ‚ç‚¹ï¼‰


## ç‰¹æ®ŠPage
- root page: æœ¬è´¨ä¸Šæ˜¯ContentsPage
- æ¯ä¸ªsegmentéƒ½å­˜åœ¨ä¸€ä¸ªrootï¼Œç³»ç»Ÿå…è®¸å¤šä¸ªrootå­˜åœ¨
- å¤šä¸ªrootä¹‹é—´å¹¶åˆ—æ˜¾ç¤º
- **root page æ²¡æœ‰çˆ¶èŠ‚ç‚¹**ï¼šè¿™æ˜¯ç³»ç»Ÿä¸­å”¯ä¸€å…è®¸æ²¡æœ‰çˆ¶èŠ‚ç‚¹çš„ Page


## Page ç»“æ„å®Œæ•´æ€§çº¦æŸ

**æ ¸å¿ƒçº¦æŸ**ï¼šé™¤äº† root page å¤–ï¼Œæ‰€æœ‰ Page éƒ½å¿…é¡»æœ‰çˆ¶èŠ‚ç‚¹ã€‚

è¿™ä¸ªçº¦æŸç¡®ä¿ï¼š
1. **æ²¡æœ‰å­¤å„¿èŠ‚ç‚¹**ï¼šæ¯ä¸ªéæ ¹ Page éƒ½å¯ä»¥é€šè¿‡çˆ¶èŠ‚ç‚¹é“¾è¿½æº¯åˆ° root
2. **æ ‘ç»“æ„å®Œæ•´**ï¼šä» root page å¯ä»¥éå†åˆ°æ‰€æœ‰å­å­™èŠ‚ç‚¹
3. **é˜²æ­¢æ‚¬ç©º**ï¼šé¿å… page è¢«åˆ›å»ºåæ— æ³•é€šè¿‡æ ‘ç»“æ„è®¿é—®

**éªŒè¯è§„åˆ™**ï¼š
```go
// åˆ›å»º Page æ—¶çš„éªŒè¯
if page.GetParent() == "" {
    // æ²¡æœ‰ parentï¼Œå¿…é¡»æ˜¯æŸä¸ª Segment çš„ root
    if page.GetIndex() != segment.GetRootIndex() {
        return error("åªæœ‰ root page å¯ä»¥æ²¡æœ‰çˆ¶èŠ‚ç‚¹")
    }
} else {
    // æœ‰ parentï¼Œå¿…é¡»éªŒè¯ parent å­˜åœ¨ä¸”æ˜¯ ContentsPage
    parent := contextSystem.GetPage(page.GetParent())
    if parent == nil {
        return error("çˆ¶èŠ‚ç‚¹ä¸å­˜åœ¨")
    }
    if !isContentsPage(parent) {
        return error("çˆ¶èŠ‚ç‚¹å¿…é¡»æ˜¯ ContentsPage")
    }
}
```


## Pageçš„ç”Ÿå‘½å‘¨æœŸ
- Active: Activeçš„Pageå¯¹Agentæ˜¯å¯è§çš„ï¼ŒActiveçš„Pageåˆ†ä¸ºä¸¤ç±»
  - Expanded: å¦‚æœæ˜¯ContentsPageï¼Œå­èŠ‚ç‚¹å¯è§ï¼›å¦‚æœæ˜¯DetailPageï¼Œdetailå¯è§
  - hidden: å¦‚æœæ˜¯ContentsPageï¼Œè‡ªèº«å¯è§ï¼Œä½†å­èŠ‚ç‚¹ä¸å¯è§ï¼›å¦‚æœæ˜¯DetailPageï¼Œdescriptionå¯è§ä½†detailä¸å¯è§
- HotArchived: HotArchivedçš„Pageä¸åœ¨ä¸Šä¸‹æ–‡çª—å£å†…ï¼Œæ•…å®Œå…¨ä¸å¯è§ï¼Œä½†å®ƒå­˜åœ¨ç¥–å…ˆpageæ˜¯Activeçš„ï¼Œæ­¤æ—¶Agentå¯èƒ½é€šè¿‡å±‚å±‚å±•å¼€å°†å…¶é‡æ–°å˜æˆActiveçŠ¶æ€
- ColdArchived: ColdArchivedçš„Pageä¸åœ¨ä¸Šä¸‹æ–‡çª—å£å†…ï¼Œè¿™ç±»Pageå·²ç»å®Œå…¨è„±ç¦»ä¸Šä¸‹æ–‡ç³»ç»Ÿï¼Œå½“æŸä¸ªPageè¢«Agentè®¤ä¸ºä¸å†éœ€è¦å¹¶è¢«å¸è½½å‡ºä¸Šä¸‹æ–‡çª—å£æ—¶ï¼Œè¯¥PageåŠå…¶æ‰€æœ‰åä»£Pageéƒ½å˜æˆColdArchivedçŠ¶æ€ï¼ŒAgentå¯¹å…¶å¤±å»ç›´æ¥æ„ŸçŸ¥çš„èƒ½åŠ›ï¼Œåªèƒ½ç”±å¤–éƒ¨è®°å¿†ç³»ç»Ÿé‡æ–°æ£€ç´¢æ³¨å…¥


## Storage å­˜å‚¨æ¶æ„

ContextSystem é€šè¿‡ **Storage æ¥å£** å®ç°å¯æ’æ‹”çš„å­˜å‚¨åç«¯ï¼Œé‡‡ç”¨ **åŒå±‚å­˜å‚¨æ¶æ„**ï¼šå†…å­˜ç¼“å­˜ + æŒä¹…åŒ–å­˜å‚¨ã€‚

### åŒå±‚å­˜å‚¨æ¶æ„

```
ContextSystem
    â”‚
    â”œâ”€â”€ å†…å­˜ç¼“å­˜ (map[PageIndex]Page)
    â”‚   â”œâ”€â”€ å¿«é€Ÿè®¿é—® (nsçº§å»¶è¿Ÿ)
    â”‚   â”œâ”€â”€ è¯»å†™æ“ä½œä¼˜å…ˆ
    â”‚   â””â”€â”€ LRUé©±é€ç®¡ç†
    â”‚
    â””â”€â”€ Storage æ¥å£
        â”œâ”€â”€ è‡ªåŠ¨æŒä¹…åŒ–ï¼ˆå†™æ“ä½œï¼‰
        â”œâ”€â”€ æ‡’åŠ è½½ï¼ˆè¯»æ“ä½œï¼‰
        â””â”€â”€ å¯æ’æ‹”å®ç°ï¼š
            â”œâ”€â”€ MemoryStorageï¼ˆå†…å­˜ï¼Œé»˜è®¤ï¼‰
            â”œâ”€â”€ FileStorageï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰
            â”œâ”€â”€ DatabaseStorageï¼ˆæ•°æ®åº“ï¼‰
            â””â”€â”€ S3Storageï¼ˆäº‘å­˜å‚¨ï¼Œå¯æ‰©å±•ï¼‰
```

### æ ¸å¿ƒç‰¹æ€§

1. **æ¥å£è§£è€¦**ï¼šContextSystem æŒæœ‰ Storage æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
2. **è‡ªåŠ¨æŒä¹…åŒ–**ï¼šå†™æ“ä½œï¼ˆAddPageã€UpdatePageã€RemovePageï¼‰è‡ªåŠ¨åŒæ­¥åˆ°å­˜å‚¨
3. **æ‡’åŠ è½½**ï¼šè¯»æ“ä½œï¼ˆGetPageï¼‰ä¼˜å…ˆæ£€æŸ¥å†…å­˜ï¼Œæœªå‘½ä¸­æ—¶ä»å­˜å‚¨åŠ è½½
4. **å­˜å‚¨åˆ‡æ¢**ï¼šå¯åœ¨è¿è¡Œæ—¶åˆ‡æ¢å­˜å‚¨å®ç°ï¼Œæ”¯æŒæ•°æ®è¿ç§»
5. **äº‹åŠ¡å›æ»š**ï¼šæŒä¹…åŒ–å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šå†…å­˜æ“ä½œï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§

### è‡ªåŠ¨æŒä¹…åŒ–ç¤ºä¾‹

```go
// å†™æ“ä½œï¼šè‡ªåŠ¨æŒä¹…åŒ–åˆ°å­˜å‚¨
contextSystem.AddPage(page)
// å†…éƒ¨æ‰§è¡Œï¼š
// 1. cs.pages[pageIndex] = page          // æ›´æ–°å†…å­˜
// 2. cs.storage.Save(page)               // æŒä¹…åŒ–
// 3. å¦‚æœå¤±è´¥ï¼Œå›æ»šå†…å­˜æ“ä½œ

// è¯»æ“ä½œï¼šæ‡’åŠ è½½æœºåˆ¶
page, err := contextSystem.GetPage("usr-1")
// å†…éƒ¨æ‰§è¡Œï¼š
// 1. æ£€æŸ¥å†…å­˜ç¼“å­˜ cs.pages["usr-1"]
// 2. å¦‚æœæœªå‘½ä¸­ï¼Œæ£€æŸ¥å­˜å‚¨ cs.storage.Exists("usr-1")
// 3. å¦‚æœå­˜åœ¨ï¼Œä»å­˜å‚¨åŠ è½½å¹¶ç¼“å­˜åˆ°å†…å­˜
// 4. è¿”å› Page
```

### å­˜å‚¨å®ç°é€‰æ‹©

| å­˜å‚¨ç±»å‹ | é€‚ç”¨åœºæ™¯ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|---------|---------|------|------|
| MemoryStorage | å•å…ƒæµ‹è¯•ã€çŸ­æœŸè¿è¡Œ | é›¶å»¶è¿Ÿã€ç®€å• | é‡å¯ä¸¢å¤± |
| FileStorage | æœ¬åœ°æŒä¹…åŒ–ã€è°ƒè¯• | å¯é ã€æ˜“è°ƒè¯• | å¹¶å‘æ€§èƒ½ä½ |
| DatabaseStorage | ç”Ÿäº§ç¯å¢ƒã€åˆ†å¸ƒå¼ | äº‹åŠ¡æ”¯æŒã€é«˜å¹¶å‘ | å¤æ‚åº¦é«˜ |
| S3Storage | äº‘å­˜å‚¨ã€å¤§è§„æ¨¡æ‰©å±• | é«˜å¯ç”¨ã€æ— é™æ‰©å±• | ç½‘ç»œå»¶è¿Ÿ |

**è¯¦ç»†è®¾è®¡è¯·å‚è€ƒ**ï¼š[context_system.md](context_system.md#å­˜å‚¨ç”Ÿå‘½å‘¨æœŸç®¡ç†)


## ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿ vs è®°å¿†ç®¡ç†ç³»ç»Ÿ
- ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿå†³å®šæ¨¡å‹ä¸Šä¸‹æ–‡çª—å£åº”è¯¥å­˜åœ¨ä¸€äº›ä»€ä¹ˆä¿¡æ¯
- è®°å¿†ç®¡ç†ç³»ç»Ÿå†³å®šåº”è¯¥æŠŠä»€ä¹ˆä¿¡æ¯æŒä¹…åŒ–åˆ°å¤–éƒ¨æ–‡ä»¶ï¼Œå¦‚ä½•ä»å¤–éƒ¨æ–‡ä»¶æ£€ç´¢è®°å¿†ä¿¡æ¯ï¼Œå¦‚ä½•é€šè¿‡å¤„ç†è®°å¿†ä¿¡æ¯æå‡Agentä¸ç”¨æˆ·çš„é€‚é…åº¦

## å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

ä»¥ä¸‹å±•ç¤ºå¦‚ä½•ä½¿ç”¨ ContextManager æ„å»ºä¸€ä¸ªå®Œæ•´çš„ AI åŠ©æ‰‹åº”ç”¨ï¼š

```go
package main

import (
    "context"
    "log"
    "memci/context"
    "memci/llm"
)

func main() {
    // 1. åˆ›å»º ContextManagerï¼ˆåº”ç”¨åªéœ€è¿™ä¸€ä¸ªç»„ä»¶ï¼‰
    ctxMgr := context.NewContextManager()

    // 2. åˆå§‹åŒ–ï¼ˆåˆ›å»ºé»˜è®¤çš„ç³»ç»Ÿæç¤ºè¯æ®µå’Œç”¨æˆ·äº¤äº’æ®µï¼‰
    if err := ctxMgr.Initialize(); err != nil {
        log.Fatal(err)
    }

    // 3. è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼‰
    systemPrompt := `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„Goè¯­è¨€ç¼–ç¨‹åŠ©æ‰‹ã€‚
ä½ çš„èŒè´£æ˜¯ï¼š
1. å‡†ç¡®å›ç­”Goç›¸å…³é—®é¢˜
2. æä¾›æ¸…æ™°çš„ä»£ç ç¤ºä¾‹
3. è§£é‡Šå¤æ‚çš„å¹¶å‘æ¦‚å¿µ`

    // 4. æ·»åŠ ç³»ç»Ÿæç¤ºè¯åˆ°ç³»ç»Ÿæ®µ
    sysRoot, _ := ctxMgr.GetPage("sys-0")
    if sysRootPage, ok := sysRoot.(*ContentsPage); ok {
        // åˆ›å»ºç³»ç»Ÿæç¤ºè¯ DetailPage
        sysPromptIndex, err := ctxMgr.CreateDetailPage(
            "System Prompt",
            "Main system prompt",
            systemPrompt,
            "sys-0",
        )
        if err != nil {
            log.Fatal(err)
        }

        // å±•å¼€ç³»ç»Ÿæç¤ºè¯
        if err := ctxMgr.ExpandDetails(sysPromptIndex); err != nil {
            log.Fatal(err)
        }
    }

    // 5. å¯åŠ¨å¯¹è¯å¾ªç¯
    for {
        // è·å–ç”¨æˆ·è¾“å…¥
        userInput := getUserInput()

        // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯ Page
        userPageIndex, err := ctxMgr.CreateDetailPage(
            "User Question",
            "ç”¨æˆ·çš„é—®é¢˜",
            userInput,
            "usr-0",
        )
        if err != nil {
            log.Printf("Failed to create user page: %v", err)
            continue
        }

        // å±•å¼€ç”¨æˆ·é—®é¢˜
        if err := ctxMgr.ExpandDetails(userPageIndex); err != nil {
            log.Printf("Failed to expand user page: %v", err)
            continue
        }

        // ç”Ÿæˆ MessageList
        messageList, err := ctxMgr.GenerateMessageList()
        if err != nil {
            log.Printf("Failed to generate message list: %v", err)
            continue
        }

        // å‘é€ç»™ LLM
        response, err := llm.Send(context.Background(), messageList)
        if err != nil {
            log.Printf("LLM error: %v", err)
            continue
        }

        // åˆ›å»ºåŠ©æ‰‹å›å¤ Page
        assistantPageIndex, err := ctxMgr.CreateDetailPage(
            "Assistant Response",
            "AIåŠ©æ‰‹çš„å›å¤",
            response,
            "usr-0",
        )
        if err != nil {
            log.Printf("Failed to create assistant page: %v", err)
            continue
        }

        // å±•å¼€åŠ©æ‰‹å›å¤
        if err := ctxMgr.ExpandDetails(assistantPageIndex); err != nil {
            log.Printf("Failed to expand assistant page: %v", err)
        }

        // æ£€æŸ¥ token ä½¿ç”¨æƒ…å†µ
        tokens, err := ctxMgr.EstimateTokens()
        if err != nil {
            log.Printf("Failed to estimate tokens: %v", err)
        }

        log.Printf("Response generated. Current token count: %d", tokens)

        // å¦‚æœ token æ¥è¿‘ä¸Šé™ï¼Œè‡ªåŠ¨æŠ˜å å†å²å¯¹è¯
        if tokens > 7000 {
            collapsed, err := ctxMgr.AutoCollapse(6000)
            if err != nil {
                log.Printf("Auto-collapse failed: %v", err)
            } else {
                log.Printf("Collapsed %d pages to save tokens", len(collapsed))
            }
        }
    }
}

func getUserInput() string {
    // å®ç°ç”¨æˆ·è¾“å…¥é€»è¾‘
    return ""
}
```

**ä½¿ç”¨è¦ç‚¹**ï¼š
1. **å•ä¸€å…¥å£**ï¼šæ•´ä¸ªåº”ç”¨åªéœ€åˆ›å»ºä¸€ä¸ª `ContextManager` å®ä¾‹
2. **çº¿ç¨‹å®‰å…¨**ï¼šæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥åœ¨ goroutine ä¸­å¹¶å‘è°ƒç”¨
3. **è‡ªåŠ¨ç®¡ç†**ï¼š`Initialize()` è‡ªåŠ¨åˆ›å»ºç³»ç»Ÿæç¤ºè¯æ®µå’Œç”¨æˆ·äº¤äº’æ®µ
4. **ç®€å• API**ï¼šé€šè¿‡ ContextManager çš„ç»Ÿä¸€ API æ“ä½œï¼Œæ— éœ€å…³å¿ƒå†…éƒ¨ç»„ä»¶
5. **Token ç®¡ç†**ï¼šä½¿ç”¨ `EstimateTokens()` å’Œ `AutoCollapse()` ç®¡ç†ä¸Šä¸‹æ–‡çª—å£




## Agentè§†è§’çš„ä¸Šä¸‹æ–‡è§†å›¾

Agenté€šè¿‡ContextWindowæŸ¥çœ‹ä¸Šä¸‹æ–‡ï¼Œæœ€ç»ˆå‘ˆç°ä¸ºæ‰å¹³åŒ–çš„MessageListã€‚ä¸‹é¢å±•ç¤ºä¸åŒçŠ¶æ€ä¸‹Agentçš„è§†å›¾ï¼š

### è§†å›¾ç¤ºä¾‹1: åˆå§‹çŠ¶æ€ï¼ˆæ‰€æœ‰DetailPageéšè—ï¼‰

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ System: ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹...                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ“ æ ¹ç›®å½• (ContentsPage) [index: 0]                            â•‘
â•‘    æè¿°: ç”¨æˆ·äº¤äº’è®°å½•                                           â•‘
â•‘    â””â”€ [åŒ…å«3ä¸ªå­é¡µé¢ï¼Œå±•å¼€æŸ¥çœ‹è¯¦æƒ…...]                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Agentå¯æ‰§è¡Œ: expandDetails(0)  // å±•å¼€æ ¹ç›®å½•æŸ¥çœ‹å­é¡µé¢
```

### è§†å›¾ç¤ºä¾‹2: å±•å¼€ContentsPageï¼ˆæ˜¾ç¤ºå­é¡µé¢æ‘˜è¦ï¼‰

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ System: ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹...                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ“ æ ¹ç›®å½• (ContentsPage) [index: 0] [Expanded]                 â•‘
â•‘    æè¿°: ç”¨æˆ·äº¤äº’è®°å½•                                           â•‘
â•‘    â”œâ”€ ğŸ“ ç¬¬ä¸€è½®å¯¹è¯ (ContentsPage) [index: 1]                  â•‘
â•‘    â”‚   æè¿°: å…³äºGoè¯­è¨€çš„è®¨è®º                                   â•‘
â•‘    â”‚   â””â”€ [åŒ…å«2ä¸ªå­é¡µé¢...]                                   â•‘
â•‘    â”œâ”€ ğŸ“„ ç¬¬äºŒè½®å¯¹è¯ (DetailPage) [index: 2] [Hidden]           â•‘
â•‘    â”‚   æè¿°: Pythonå¼‚æ­¥ç¼–ç¨‹ç›¸å…³é—®é¢˜                            â•‘
â•‘    â””â”€ ğŸ“„ ç¬¬ä¸‰è½®å¯¹è¯ (DetailPage) [index: 3] [Hidden]           â•‘
â•‘        æè¿°: æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å»ºè®®                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Agentå¯æ‰§è¡Œ:
  - expandDetails(1)  // å±•å¼€ç¬¬ä¸€è½®å¯¹è¯ç›®å½•
  - expandDetails(2)  // æŸ¥çœ‹ç¬¬äºŒè½®å¯¹è¯è¯¦æƒ…
  - hideDetails(0)    // æŠ˜å æ ¹ç›®å½•
```

### è§†å›¾ç¤ºä¾‹3: ç»§ç»­å±•å¼€å­ContentsPage

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ System: ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹...                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ“ æ ¹ç›®å½• (ContentsPage) [index: 0] [Expanded]                 â•‘
â•‘    æè¿°: ç”¨æˆ·äº¤äº’è®°å½•                                           â•‘
â•‘    â”œâ”€ ğŸ“ ç¬¬ä¸€è½®å¯¹è¯ (ContentsPage) [index: 1] [Expanded]       â•‘
â•‘    â”‚   æè¿°: å…³äºGoè¯­è¨€çš„è®¨è®º                                   â•‘
â•‘    â”‚   â”œâ”€ ğŸ“„ goroutineåŸç† (DetailPage) [index: 4] [Hidden]    â•‘
â•‘    â”‚   â”‚   æè¿°: è§£é‡Šgoroutineçš„è°ƒåº¦æœºåˆ¶                       â•‘
â•‘    â”‚   â””â”€ ğŸ“„ channelä½¿ç”¨ (DetailPage) [index: 5] [Hidden]      â•‘
â•‘    â”‚       æè¿°: channelçš„åº•å±‚å®ç°ç»†èŠ‚                         â•‘
â•‘    â”œâ”€ ğŸ“„ ç¬¬äºŒè½®å¯¹è¯ (DetailPage) [index: 2] [Hidden]           â•‘
â•‘    â”‚   æè¿°: Pythonå¼‚æ­¥ç¼–ç¨‹ç›¸å…³é—®é¢˜                            â•‘
â•‘    â””â”€ ğŸ“„ ç¬¬ä¸‰è½®å¯¹è¯ (DetailPage) [index: 3] [Hidden]           â•‘
â•‘        æè¿°: æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å»ºè®®                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Agentå¯æ‰§è¡Œ:
  - expandDetails(4)  // æŸ¥çœ‹goroutineåŸç†è¯¦æƒ…
  - movePage(5, 0)    // å°†channelä½¿ç”¨ç§»åˆ°æ ¹ç›®å½•ä¸‹
  - removePage(3)     // åˆ é™¤ç¬¬ä¸‰è½®å¯¹è¯
```

### è§†å›¾ç¤ºä¾‹4: å±•å¼€DetailPageï¼ˆæ˜¾ç¤ºåŸå§‹æ¶ˆæ¯ï¼‰

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ System: ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹...                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ“ æ ¹ç›®å½• (ContentsPage) [index: 0] [Expanded]                 â•‘
â•‘    æè¿°: ç”¨æˆ·äº¤äº’è®°å½•                                           â•‘
â•‘    â”œâ”€ ğŸ“ ç¬¬ä¸€è½®å¯¹è¯ (ContentsPage) [index: 1] [Expanded]       â•‘
â•‘    â”‚   æè¿°: å…³äºGoè¯­è¨€çš„è®¨è®º                                   â•‘
â•‘    â”‚   â”œâ”€ ğŸ“„ goroutineåŸç† (DetailPage) [index: 4] [Expanded]  â•‘
â•‘    â”‚   â”‚   æè¿°: è§£é‡Šgoroutineçš„è°ƒåº¦æœºåˆ¶                       â•‘
â•‘    â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘    â”‚   â”‚   â”‚ User: Goçš„goroutineæ˜¯å¦‚ä½•è°ƒåº¦çš„ï¼Ÿ            â”‚     â•‘
â•‘    â”‚   â”‚   â”‚ Assistant: Goè¿è¡Œæ—¶ä½¿ç”¨G-Mè°ƒåº¦æ¨¡å‹...        â”‚     â•‘
â•‘    â”‚   â”‚   â”‚ User: èƒ½è¯¦ç»†è§£é‡Šä¸€ä¸‹Pçš„ä½œç”¨å—ï¼Ÿ              â”‚     â•‘
â•‘    â”‚   â”‚   â”‚ Assistant: Pæ˜¯é€»è¾‘å¤„ç†å™¨...                  â”‚     â•‘
â•‘    â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘    â”‚   â””â”€ ğŸ“„ channelä½¿ç”¨ (DetailPage) [index: 5] [Hidden]     â•‘
â•‘    â”œâ”€ ğŸ“„ ç¬¬äºŒè½®å¯¹è¯ (DetailPage) [index: 2] [Hidden]           â•‘
â•‘    â””â”€ ğŸ“„ ç¬¬ä¸‰è½®å¯¹è¯ (DetailPage) [index: 3] [Hidden]           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                   â”‚
                                   â””â”€ æ¶ˆè€—è¾ƒå¤šä¸Šä¸‹æ–‡çª—å£

Agentå¯æ‰§è¡Œ:
  - hideDetails(4)     // éšè—goroutineè¯¦æƒ…ï¼ˆèŠ‚çœä¸Šä¸‹æ–‡ï¼‰
  - createContentsPage("Goæ·±å…¥", "Goè¯­è¨€ä¸“é¢˜è®¨è®º", 4, 5)  // æ•´ç†ä¸ºç›®å½•
```

### è§†å›¾ç¤ºä¾‹5: å¤šä¸ªSegmentå¹¶åˆ—æ˜¾ç¤ºï¼ˆå¤šä¸ªRootï¼‰

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ System: ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹...                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â•‘
â•‘ ğŸ“ ç³»ç»Ÿæç¤ºè¯æ®µ (ContentsPage) [index: sys-0] [Expanded]       â•‘
â•‘    æè¿°: ç³»ç»Ÿçº§ä¸Šä¸‹æ–‡å’Œè§„åˆ™                                     â•‘
â•‘    â”œâ”€ ğŸ“„ ç³»ç»Ÿæç¤ºè¯ (DetailPage) [index: sys-1] [Expanded]     â•‘
â•‘    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â•‘
â•‘    â”‚   â”‚ ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹ï¼Œéµå¾ªä»¥ä¸‹è§„åˆ™ï¼š              â”‚         â•‘
â•‘    â”‚   â”‚ 1. ä¿æŒç¤¼è²Œå’Œä¸“ä¸š                           â”‚         â•‘
â•‘    â”‚   â”‚ 2. ä¸æä¾›æœ‰å®³å†…å®¹                           â”‚         â•‘
â•‘    â”‚   â”‚ 3. å°Šé‡ç”¨æˆ·éšç§                             â”‚         â•‘
â•‘    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â•‘
â•‘    â””â”€ ğŸ“„ å®‰å…¨è§„åˆ™ (DetailPage) [index: sys-2] [Hidden]        â•‘
â•‘        æè¿°: å†…å®¹å®‰å…¨å’Œåˆè§„è¦æ±‚                                â•‘
â•‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â•‘
â•‘ ğŸ“ ç”¨æˆ·äº¤äº’æ®µ (ContentsPage) [index: usr-0] [Expanded]         â•‘
â•‘    æè¿°: ç”¨æˆ·å¯¹è¯å†å²                                           â•‘
â•‘    â”œâ”€ ğŸ“ ç¬¬ä¸€è½®å¯¹è¯ (ContentsPage) [index: usr-1]              â•‘
â•‘    â”‚   æè¿°: å…³äºGoè¯­è¨€çš„è®¨è®º                                   â•‘
â•‘    â””â”€ ğŸ“„ ç¬¬äºŒè½®å¯¹è¯ (DetailPage) [index: usr-2] [Hidden]       â•‘
â•‘        æè¿°: Pythonå¼‚æ­¥ç¼–ç¨‹ç›¸å…³é—®é¢˜                            â•‘
â•‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¯´æ˜ï¼š
- ä¸åŒSegmentçš„indexä½¿ç”¨å‰ç¼€åŒºåˆ†ï¼ˆsys-*, usr-*ï¼‰
- ç³»ç»Ÿæç¤ºè¯æ®µé»˜è®¤ä¸ºExpandedï¼Œç¡®ä¿Agentå§‹ç»ˆå—çº¦æŸ
- Agentä¸èƒ½å¯¹ç³»ç»Ÿæç¤ºè¯root Pageæ‰§è¡ŒhideDetails()æ“ä½œ
```

### è§†å›¾ç¤ºä¾‹6: DetailPageè¢«HotArchivedï¼ˆç¥–å…ˆæŠ˜å åä¸å¯è§ï¼‰

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ System: ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹...                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ“ æ ¹ç›®å½• (ContentsPage) [index: 0] [Hidden]                   â•‘
â•‘    æè¿°: ç”¨æˆ·äº¤äº’è®°å½•                                           â•‘
â•‘    â””â”€ [åŒ…å«3ä¸ªå­é¡µé¢ï¼Œå±•å¼€æŸ¥çœ‹è¯¦æƒ…...]                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        â”‚
        â–¼ çŠ¶æ€å˜åŒ–ï¼ˆæŠ˜å åçš„å†…éƒ¨çŠ¶æ€ï¼‰
        â”‚
        â”œâ”€ ç¬¬ä¸€è½®å¯¹è¯ [index: 1] â†’ HotArchived (ä¸å¯è§)
        â”‚   â”œâ”€ goroutineåŸç† [index: 4] â†’ HotArchived (ä¸å¯è§)
        â”‚   â””â”€ channelä½¿ç”¨ [index: 5] â†’ HotArchived (ä¸å¯è§)
        â”œâ”€ ç¬¬äºŒè½®å¯¹è¯ [index: 2] â†’ HotArchived (ä¸å¯è§)
        â””â”€ ç¬¬ä¸‰è½®å¯¹è¯ [index: 3] â†’ HotArchived (ä¸å¯è§)

Agentå¯æ‰§è¡Œ: expandDetails(0)  // é‡æ–°æ¿€æ´»æ ¹ç›®å½•ï¼Œå­é¡µé¢æ¢å¤Active
```

### è§†å›¾ç¤ºä¾‹7: ä¸Šä¸‹æ–‡çª—å£ç®¡ç†ï¼ˆè‡ªåŠ¨æŠ˜å ä»¥é€‚åº”çª—å£ï¼‰

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ System: ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹...                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ“ å†å²è®¨è®º (ContentsPage) [index: 0] [Hidden]                 â•‘
â•‘    æè¿°: 2025å¹´1æœˆçš„å¯¹è¯è®°å½•                                    â•‘
â•‘    â””â”€ [åŒ…å«15ä¸ªå­é¡µé¢...] â—„â”€â”€â”€â”€â”€â”€ å·²å‹ç¼©ä¸ºæ‘˜è¦                  â•‘
â•‘                                                               â•‘
â•‘ ğŸ“ æœ€è¿‘è®¨è®º (ContentsPage) [index: 1] [Expanded]               â•‘
â•‘    æè¿°: 2025å¹´2æœˆçš„å¯¹è¯è®°å½•                                    â•‘
â•‘    â”œâ”€ ğŸ“„ Goå¹¶å‘ (DetailPage) [index: 2] [Hidden]               â•‘
â•‘    â”œâ”€ ğŸ“„ AIæ¶æ„è®¾è®¡ (DetailPage) [index: 3] [Expanded]         â•‘
â•‘    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘    â”‚   â”‚ [å®Œæ•´çš„åŸå§‹æ¶ˆæ¯å†…å®¹...]                           â”‚   â•‘
â•‘    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘    â””â”€ ğŸ“„ å½“å‰é—®é¢˜ (DetailPage) [index: 4] [Expanded]          â•‘
â•‘        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘        â”‚ User: å¦‚ä½•ç†è§£Memciçš„ä¸Šä¸‹æ–‡ç³»ç»Ÿè®¾è®¡ï¼Ÿ               â•‘
â•‘        â”‚ Assistant: [æ­£åœ¨ç”Ÿæˆå›ç­”...]                       â•‘
â•‘        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        â”‚
        â–¼ å½“ä¸Šä¸‹æ–‡çª—å£æ¥è¿‘æ»¡è½½æ—¶ï¼ˆç³»ç»Ÿè‡ªåŠ¨æŠ˜å ï¼‰
        â”‚
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ System: ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹...                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ“ å†å²è®¨è®º [index: 0] [Hidden] â—„â”€â”€â”€â”€â”€â”€ HotArchived            â•‘
â•‘ ğŸ“ æœ€è¿‘è®¨è®º [index: 1] [Hidden] â—„â”€â”€â”€â”€â”€â”€ è¢«è‡ªåŠ¨æŠ˜å               â•‘
â•‘ ğŸ“„ AIæ¶æ„è®¾è®¡ [index: 3] [Hidden]                               â•‘
â•‘ ğŸ“„ å½“å‰é—®é¢˜ [index: 4] [Expanded]                               â•‘
â•‘     [å½“å‰æ´»è·ƒå¯¹è¯...]                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Agentå¯æ‰§è¡Œ: expandDetails(1)  // æ‰‹åŠ¨å±•å¼€æœ€è¿‘è®¨è®ºç›®å½•
```

## ä¸Šä¸‹æ–‡è§†å›¾ä¸MessageListçš„æ˜ å°„

ContextWindow è´Ÿè´£å°† Page Tree æ¸²æŸ“ä¸º MessageListï¼Œè¿™æ˜¯æœ€ç»ˆå‘é€ç»™æ¨¡å‹çš„å†…å®¹ã€‚

```
Page Tree (é€»è¾‘è§†å›¾)              MessageList (å®é™…å‘é€ç»™æ¨¡å‹)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ sys-0 [Expanded]             â†’  MessageNode: "ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹..."
â”œâ”€ ğŸ“„ sys-1 [Expanded]          â†’  (å†…å®¹å·²åŒ…å«åœ¨ sys-0 ä¸­)
â”‚   â””â”€ detail: "ç³»ç»Ÿæç¤ºè¯..."
ğŸ“ usr-0 [Expanded]             â†’  MessageNode: "ç”¨æˆ·è®¨è®º\n\nè¯¦ç»†..."
â”œâ”€ ğŸ“ usr-1 [Hidden]            â†’  (ä»…æ˜¾ç¤ºæ‘˜è¦ï¼š"å…³äºGoçš„è®¨è®º")
â”‚   â””â”€ description: "å…³äºGoçš„è®¨è®º"
â””â”€ ğŸ“„ usr-2 [Expanded]          â†’  MessageNode: "å¦‚ä½•å®ç°goroutineï¼Ÿ..."
    â””â”€ detail: "è¯¦ç»†é—®é¢˜..."

æ¸²æŸ“è§„åˆ™ï¼š
- Active + Expanded: æ˜¾ç¤ºå®Œæ•´å†…å®¹
- Active + Hidden: ä»…æ˜¾ç¤ºæ‘˜è¦
- HotArchived/ColdArchived: ä¸æ¸²æŸ“
```

**ContextWindow çš„æ¸²æŸ“èŒè´£**ï¼ˆè¯¦è§ [context_window.md](context_window.md)ï¼‰ï¼š
1. éå†æ‰€æœ‰ Active çš„ Page
2. æ ¹æ® Visibility å†³å®šæ¸²æŸ“ç­–ç•¥
3. å°†ç»“æœç»„è£…æˆ MessageList
4. ä¼°ç®— token æ•°é‡ï¼Œå¿…è¦æ—¶è‡ªåŠ¨æŠ˜å 

## Agentæ“ä½œä¸è§†å›¾å˜åŒ–

| Agentæ“ä½œ | è§†å›¾å˜åŒ– | ä¸Šä¸‹æ–‡çª—å£å½±å“ |
|-----------|----------|----------------|
| `expandDetails(pageIndex)` | Hidden â†’ Expanded | å¢åŠ ï¼ˆåŠ è½½åŸå§‹æ¶ˆæ¯ï¼‰ |
| `hideDetails(pageIndex)` | Expanded â†’ Hidden | å‡å°‘ï¼ˆä¿ç•™æ‘˜è¦ï¼‰ |
| `createContentsPage(...)` | æ–°å¢ç›®å½•èŠ‚ç‚¹ | è½»å¾®å¢åŠ ï¼ˆæ‘˜è¦ï¼‰ |
| `createDetailPage(...)` | æ–°å¢å¶å­èŠ‚ç‚¹ | ä¸­ç­‰å¢åŠ ï¼ˆdetailå†…å®¹ï¼‰ |
| `movePage(...)` | æ ‘ç»“æ„è°ƒæ•´ | å–å†³äºç›®æ ‡ä½ç½®çŠ¶æ€ |
| `removePage(...)` | åˆ é™¤å­æ ‘ | å‡å°‘ï¼ˆé‡Šæ”¾ç©ºé—´ï¼‰ |
