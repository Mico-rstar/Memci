## 介绍
这是Memci的上下文管理设计文档

## 基本抽象
- **Entry**: entry上下文系统最小单位，一个entry对应MessageList中的一个MessageNode
- **Page**: page是上下文系统管理的基本单位，一个page逻辑上对应与用户的一次交互产生的多条entry(一条用户entry以及多条assistant或tool entry)，上下文系统对于上下文的卸载和召回以page为单位。
- **Chapter**: chapter是一组相关page的集合，chapter对于LLM来说是不可见。chapter是上下文管理的关键，chapter能够将其拥有的所有页卸载出上下文窗口，并生成一个Contents Page放入上下文窗口
- **Contents Page**: 目录页是上下文系统为LLM提供的压缩视图，LLM可以通过目录页看到被卸载出上下文窗口的Page的index，LLM可以通过index召回Page
- **Segment**: Segment拥有一个或多个Chapter，Segment是提供给开发者从一个宏观视角组织上下文的一个抽象，目前上下文系统支持的Segment有 System Segment(系统提示词部分), Common Segment（用户交互上下文部分）

## 上下文管理策略
### Segment层次
Segment将整个上下文分为 System Segment 和 Common Segement

### 卸载策略
1. 目前System Segement仅拥有一个System chapter
2. Common Segment管理 ArchiveChapter 和 ActiveChapter
   1. ArchiveChapter表示原始page已经被卸载出上下文窗口，但保留了一个Contents Page记录了摘要信息和索引，用于给llm召回
   2. ActiveChapter管理最近 n page，它管理的page直接放在上下文窗口里
3. ActiveChapter超出n page部分会给ArchiveChapter进行归档
4. ArchiveChapter会将新进的Page进行逐个entry摘要，生成 page index，放入 contents Page，然后将原始page卸载到文件系统
5. ArchiveChapter会记录每个Page被索引次数，卸载按照如下规则：
   1. m 轮对话后还是索引=0 -> 卸载
   2. contents page达到MaxToken限制，按照 LRU策略卸载
   3. p轮对话后索引次数没变过 -> 卸载
6. 被彻底卸载的page并没有从此消失，而是可以由记忆系统检索，但模型无法直接感知其存在

### 召回策略
1. Contents Page设计规则：
   1. 每个page都有一个唯一的index
   2. 每个page中的每条entry都进行摘要，放在对应page条目下，作为llm回忆的锚点
2. 在系统提示词中提供召回的原生工具，工具协议按照 @ATTP.md 
3. LLM根据ATTP协议调用工具召回page
4. 系统更新召回page的召回时间，召回次数


### 示意图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           层次结构                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Entry ──► Entry ──► Entry                                                   │
│    │           │           │                                                │
│    └───────────┴───────────┘                                                │
│                │                                                            │
│                ▼                                                            │
│  ┌─────────────────────────────────┐                                        │
│  │           Page                  │  ← 用户一次交互（用户entry + assistant）│
│  │  ┌─────────────────────────┐   │                                        │
│  │  │ Entry1 (User)           │   │                                        │
│  │  │ Entry2 (Assistant)      │   │                                        │
│  │  │ Entry3 (Tool)           │   │                                        │
│  │  └─────────────────────────┘   │                                        │
│  └─────────────────────────────────┘                                        │
│                │                                                            │
│                ▼                                                            │
│  ┌─────────────────────────────────┐                                        │
│  │         Chapter                 │  ← 管理多个 Page，可卸载并生成 Contents │
│  │  ┌───┐ ┌───┐ ┌───┐ ┌───┐      │                                        │
│  │  │P1 │ │P2 │ │P3 │ │P4 │ ...  │                                        │
│  │  └───┘ └───┘ └───┘ └───┘      │                                        │
│  └─────────────────────────────────┘                                        │
│                │                                                            │
│                ▼                                                            │
│  ┌─────────────────────────────────┐                                        │
│  │         Segment                 │  ← 宏观组织单位                        │
│  │  ┌─────────────────────┐       │                                        │
│  │  │ Chapter1 + Chapter2 │       │                                        │
│  │  └─────────────────────┘       │                                        │
│  └─────────────────────────────────┘                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                      上下文窗口布局 (Context Window)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                    System Segment                                     │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │  System Chapter: 系统提示词 + 召回工具 (ATTP 协议)             │  │  │
│  │  └────────────────────────────────────────────────────────────────┘  │  │
│  ├──────────────────────────────────────────────────────────────────────┤  │
│  │                    Common Segment                                     │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │  ArchiveChapter → Contents Page (压缩视图)                     │  │  │
│  │  │  ┌──────────────────────────────────────────────────────────┐  │  │  │
│  │  │  │ [Page #42] 用户询问如何优化查询                          │  │  │  │
│  │  │  │   └─ User: 如何优化数据库查询...                         │  │  │  │
│  │  │  │   └─ Assistant: 建议添加索引...                          │  │  │  │
│  │  │  │   └─ 召回次数: 2, 最后召回: 5轮前                         │  │  │  │
│  │  │  │                                                          │  │  │  │
│  │  │  │ [Page #18] 用户讨论 API 设计                             │  │  │  │
│  │  │  │   └─ User: REST 还是 GraphQL...                          │  │  │  │
│  │  │  │   └─ Assistant: 推荐使用 REST...                          │  │  │  │
│  │  │  │   └─ 召回次数: 0, 最后召回: 12轮前                        │  │  │  │
│  │  │  └──────────────────────────────────────────────────────────┘  │  │  │
│  │  ├────────────────────────────────────────────────────────────────┤  │  │
│  │  │  ActiveChapter (最近 n 个 Page，完整内容)                     │  │  │
│  │  │  ┌──────────────────────────────────────────────────────────┐  │  │  │
│  │  │  │ Page #99: [完整 Entry1, Entry2, Entry3...]              │  │  │  │
│  │  │  │ Page #100: [完整 Entry1, Entry2, Entry3...]             │  │  │  │
│  │  │  │ ...                                                       │  │  │  │
│  │  │  │ Page #105: [完整 Entry1, Entry2, Entry3...]             │  │  │  │
│  │  │  └──────────────────────────────────────────────────────────┘  │  │  │
│  │  └────────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                              ▲                                               │
│                              │ 上下文窗口边界                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          卸载与召回流程                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────┐         ┌──────────────┐         ┌─────────────┐        │
│    │ 新 Page 进入 │ ───n满──►│ 归档到       │ ───立即──►│ Page 卸载到  │        │
│    │ ActiveChapter│         │ ArchiveChapter│   卸载    │ 文件系统     │        │
│    └─────────────┘         └──────────────┘         └─────────────┘        │
│                                     │                                       │
│                                     ▼                                       │
│                            ┌──────────────┐                                │
│                            │ 生成 Contents│                                │
│                            │ Page 条目     │                                │
│                            │ (摘要+索引)   │                                │
│                            └──────────────┘                                │
│                                     │                                       │
│                                     ▼                                       │
│    ┌─────────────┐         ┌──────────────┐   ┌─────────────┐            │
│    │ LLM 调用     │ ◄──ATTP─┤  Contents    │◄──│ 条目卸载条件 │            │
│    │ 召回工具     │         │  Page 条目   │   │ 触发         │            │
│    └─────────────┘         └──────────────┘   └─────────────┘            │
│           │                       │                                        │
│           ▼                       ▼                                        │
│    ┌─────────────┐         ┌──────────────┐                                │
│    │ 从文件系统  │         │ 条目被删除   │                                │
│    │ 恢复 Page   │         │ (模型无法感知)│                                │
│    │ 插入窗口    │         └──────────────┘                                │
│    └─────────────┘              │                                        │
│           │                     ▼                                        │
│           ▼              ┌──────────────┐                                │
│    ┌─────────────┐        │ 由记忆系统   │                                │
│    │ 更新召回统计 │        │ 检索召回     │                                │
│    │ (时间+次数)  │        └──────────────┘                                │
│    └─────────────┘                                                          │
│                                                                             │
│  条目卸载条件 (从 Contents Page 删除):                                       │
│  1. m 轮对话后 召回次数 = 0                                                  │
│  2. Contents Page 达到 MaxToken，按 LRU 卸载                                │
│  3. p 轮对话后 召回次数未变化                                                │
│                                                                             │
│  说明:                                                                      │
│  - Page 进入 ArchiveChapter 后立即卸载到文件系统，只保留 Contents Page 条目   │
│  - 条目卸载后，Page 对模型完全不可见，只能由记忆系统检索召回                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```


## 上下文管理系统 vs 记忆管理系统
- 上下文管理系统决定模型上下文窗口应该存在一些什么信息
- 记忆管理系统决定应该把什么信息持久化到外部文件，如何从外部文件检索记忆信息，如何通过处理记忆信息提升Agent与用户的适配度